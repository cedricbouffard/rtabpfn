<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Anomaly Detection with TabPFN • rtabpfn</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Anomaly Detection with TabPFN">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rtabpfn</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with rtabpfn</a></li>
    <li><a class="dropdown-item" href="../articles/regression.html">Regression with TabPFN</a></li>
    <li><a class="dropdown-item" href="../articles/classification.html">Classification with TabPFN</a></li>
    <li><a class="dropdown-item" href="../articles/shap.html">SHAP Explanations with TabPFN</a></li>
    <li><a class="dropdown-item" href="../articles/anomaly-detection.html">Anomaly Detection with TabPFN</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://github.com/cedricbouffard/rtabpfn/releases/tag/v0.1.0">Version 0.1.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cedricbouffard/rtabpfn/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Anomaly Detection with TabPFN</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cedricbouffard/rtabpfn/blob/HEAD/vignettes/anomaly-detection.Rmd" class="external-link"><code>vignettes/anomaly-detection.Rmd</code></a></small>
      <div class="d-none name"><code>anomaly-detection.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>rtabpfn</code> package supports unsupervised anomaly
detection through the <code>tabpfn-extensions</code> library. This
approach uses TabPFN’s joint probability estimation to identify
observations that deviate significantly from the learned data
distribution. Anomaly scores represent the likelihood of each
observation - lower scores indicate more anomalous data points.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>First, ensure the Python environment is configured with
tabpfn-extensions:</p>
<p>Load required packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-anomaly-detection">Basic Anomaly Detection<a class="anchor" aria-label="anchor" href="#basic-anomaly-detection"></a>
</h2>
<p>Let’s use the <code>mtcars</code> dataset to detect anomalous
vehicles:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Prepare features</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"disp"</span>, <span class="st">"hp"</span>, <span class="st">"wt"</span>, <span class="st">"qsec"</span>, <span class="st">"am"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Train unsupervised model</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tab_pfn_unsupervised.html">tab_pfn_unsupervised</a></span><span class="op">(</span><span class="va">X</span>, n_estimators <span class="op">=</span> <span class="fl">4</span>, device <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Creating TabPFN Unsupervised Anomaly Detection Model</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Initializing TabPFNClassifier with 4 estimators...</span></span>
<span><span class="co">## Initializing TabPFNRegressor with 4 estimators...</span></span>
<span><span class="co">## Initializing TabPFNUnsupervisedModel...</span></span>
<span><span class="co">## Fitting unsupervised model...</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Unsupervised model training complete!</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate anomaly scores</span></span>
<span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/anomaly_scores.html">anomaly_scores</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">X</span>, n_permutations <span class="op">=</span> <span class="fl">10</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Computing anomaly scores...</span></span>
<span><span class="co">##   Input data dimensions: 32 x 7 </span></span>
<span><span class="co">##   Computing with 10 permutations...</span></span>
<span><span class="co">##   Done! Score range: 0.2061268 - 59.67083</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">scores</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">##   observation anomaly_score</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> .obs_1              2.80 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> .obs_2              1.54 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> .obs_3              1.27 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> .obs_4              1.86 </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> .obs_5              0.312</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> .obs_6              1.83</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="understanding-anomaly-scores">Understanding Anomaly Scores<a class="anchor" aria-label="anchor" href="#understanding-anomaly-scores"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add scores to original data</span></span>
<span><span class="va">mtcars_with_scores</span> <span class="op">&lt;-</span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    observation <span class="op">=</span> <span class="va">scores</span><span class="op">$</span><span class="va">observation</span>,</span>
<span>    anomaly_score <span class="op">=</span> <span class="va">scores</span><span class="op">$</span><span class="va">anomaly_score</span>,</span>
<span>    car_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">##  0.2061  0.5412  1.7375  6.4449  5.2671 59.6708</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find most anomalous vehicles</span></span>
<span><span class="va">most_anomalous</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">anomaly_score</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">most_anomalous</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"car_name"</span>, <span class="st">"anomaly_score"</span>, <span class="st">"mpg"</span>, <span class="st">"cyl"</span>, <span class="st">"hp"</span>, <span class="st">"wt"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                                car_name anomaly_score  mpg cyl  hp    wt</span></span>
<span><span class="co">## AMC Javelin                 AMC Javelin     0.2061268 15.2   8 150 3.435</span></span>
<span><span class="co">## Dodge Challenger       Dodge Challenger     0.2446634 15.5   8 150 3.520</span></span>
<span><span class="co">## Merc 450SL                   Merc 450SL     0.2488258 17.3   8 180 3.730</span></span>
<span><span class="co">## Hornet Sportabout     Hornet Sportabout     0.3119090 18.7   8 175 3.440</span></span>
<span><span class="co">## Merc 450SLC                 Merc 450SLC     0.3575786 15.2   8 180 3.780</span></span>
<span><span class="co">## Pontiac Firebird       Pontiac Firebird     0.3619120 19.2   8 175 3.845</span></span>
<span><span class="co">## Lincoln Continental Lincoln Continental     0.4486681 10.4   8 215 5.424</span></span>
<span><span class="co">## Cadillac Fleetwood   Cadillac Fleetwood     0.4926781 10.4   8 205 5.250</span></span>
<span><span class="co">## Merc 450SE                   Merc 450SE     0.5573251 16.4   8 180 4.070</span></span>
<span><span class="co">## Chrysler Imperial     Chrysler Imperial     0.6676782 14.7   8 230 5.345</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="visualizing-anomaly-scores">Visualizing Anomaly Scores<a class="anchor" aria-label="anchor" href="#visualizing-anomaly-scores"></a>
</h2>
<div class="section level3">
<h3 id="anomaly-score-distribution">Anomaly Score Distribution<a class="anchor" aria-label="anchor" href="#anomaly-score-distribution"></a>
</h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">anomaly_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">20</span>, fill <span class="op">=</span> <span class="st">"steelblue"</span>, color <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span><span class="op">)</span>, </span>
<span>             linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distribution of Anomaly Scores"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Lower scores indicate more anomalous observations"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Anomaly Score"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Frequency"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/score-distribution-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="anomaly-scores-by-feature">Anomaly Scores by Feature<a class="anchor" aria-label="anchor" href="#anomaly-scores-by-feature"></a>
</h3>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Anomaly score vs MPG</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mpg</span>, y <span class="op">=</span> <span class="va">anomaly_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, se <span class="op">=</span> <span class="cn">TRUE</span>, color <span class="op">=</span> <span class="st">"darkred"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Anomaly Score vs MPG"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Miles Per Gallon"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Anomaly Score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `geom_smooth()` using formula = 'y ~ x'</span></span></code></pre>
<p><img src="anomaly-detection_files/figure-html/scores-by-feature-1.png" class="r-plt" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Anomaly score vs Horsepower</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">hp</span>, y <span class="op">=</span> <span class="va">anomaly_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, se <span class="op">=</span> <span class="cn">TRUE</span>, color <span class="op">=</span> <span class="st">"darkred"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Anomaly Score vs Horsepower"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Horsepower"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Anomaly Score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `geom_smooth()` using formula = 'y ~ x'</span></span></code></pre>
<p><img src="anomaly-detection_files/figure-html/scores-by-feature-2.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="feature-space-with-anomaly-highlighting">Feature Space with Anomaly Highlighting<a class="anchor" aria-label="anchor" href="#feature-space-with-anomaly-highlighting"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Identify top 10% most anomalous</span></span>
<span><span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span>, <span class="fl">0.90</span><span class="op">)</span></span>
<span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">is_anomaly</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span> <span class="op">&gt;=</span> <span class="va">threshold</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">wt</span>, y <span class="op">=</span> <span class="va">hp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">is_anomaly</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">is_anomaly</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">car_name</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span>, hjust <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, vjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"steelblue"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"Normal"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"Anomalous"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Feature Space: Weight vs Horsepower"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Top 10% most anomalous highlighted (n ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">is_anomaly</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Weight (1000 lbs)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Horsepower"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/feature-space-anomalies-1.png" class="r-plt" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="detailed-anomaly-analysis">Detailed Anomaly Analysis<a class="anchor" aria-label="anchor" href="#detailed-anomaly-analysis"></a>
</h2>
<div class="section level3">
<h3 id="multi-feature-comparison">Multi-Feature Comparison<a class="anchor" aria-label="anchor" href="#multi-feature-comparison"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare normal vs anomalous across features</span></span>
<span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">is_anomaly_10pct</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span> <span class="op">&gt;=</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span>, <span class="fl">0.90</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_long</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">is_anomaly_10pct</span>, <span class="va">cyl</span>, <span class="va">disp</span>, <span class="va">hp</span>, <span class="va">wt</span>, <span class="va">qsec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">disp</span>, <span class="va">hp</span>, <span class="va">wt</span>, <span class="va">qsec</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"feature"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    feature_label <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"cyl"</span> <span class="op">~</span> <span class="st">"Cylinders"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"disp"</span> <span class="op">~</span> <span class="st">"Displacement (cu.in.)"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"hp"</span> <span class="op">~</span> <span class="st">"Horsepower"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"wt"</span> <span class="op">~</span> <span class="st">"Weight (1000 lbs)"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"qsec"</span> <span class="op">~</span> <span class="st">"1/4 mile time (sec)"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_anomaly_10pct</span>, <span class="st">"Anomalous"</span>, <span class="st">"Normal"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">feature_long</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">type</span>, y <span class="op">=</span> <span class="va">value</span>, fill <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">feature_label</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Normal"</span> <span class="op">=</span> <span class="st">"steelblue"</span>, <span class="st">"Anomalous"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Feature Comparison: Normal vs Anomalous Vehicles"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Top 10% most anomalous vs rest"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Classification"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Feature Value"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/multi-feature-comparison-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="pca-visualization">PCA Visualization<a class="anchor" aria-label="anchor" href="#pca-visualization"></a>
</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform PCA for 2D visualization</span></span>
<span><span class="va">pca_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">prcomp</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"disp"</span>, <span class="st">"hp"</span>, <span class="st">"wt"</span>, <span class="st">"qsec"</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                     scale. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtcars_with_scores</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    PC1 <span class="op">=</span> <span class="va">pca_result</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>    PC2 <span class="op">=</span> <span class="va">pca_result</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">anomaly_score</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">is_anomaly</span><span class="op">)</span>,</span>
<span>             shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">4</span>, stroke <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"darkred"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_color_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"darkgreen"</span>, mid <span class="op">=</span> <span class="st">"yellow"</span>, high <span class="op">=</span> <span class="st">"darkred"</span>,</span>
<span>                        midpoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"PCA Projection with Anomaly Highlighting"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Color = anomaly score | Red circles = top 10% anomalies"</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PC1 ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pca_result</span><span class="op">)</span><span class="op">$</span><span class="va">importance</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"% variance)"</span><span class="op">)</span>,</span>
<span>       y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PC2 ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">pca_result</span><span class="op">)</span><span class="op">$</span><span class="va">importance</span><span class="op">[</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"% variance)"</span><span class="op">)</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Anomaly Score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/pca-visualization-1.png" class="r-plt" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="threshold-selection">Threshold Selection<a class="anchor" aria-label="anchor" href="#threshold-selection"></a>
</h2>
<div class="section level3">
<h3 id="finding-optimal-threshold">Finding Optimal Threshold<a class="anchor" aria-label="anchor" href="#finding-optimal-threshold"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Examine different percentiles</span></span>
<span><span class="va">thresholds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.95</span>, <span class="fl">0.90</span>, <span class="fl">0.85</span>, <span class="fl">0.80</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span></span>
<span><span class="va">threshold_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  percentile <span class="op">=</span> <span class="va">thresholds</span>,</span>
<span>  threshold_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">thresholds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span>, <span class="va">p</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  n_anomalies <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">thresholds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span> <span class="op">&gt;=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span>, <span class="va">p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">threshold_comparison</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     percentile threshold_score n_anomalies</span></span>
<span><span class="co">## 95%       0.95       22.226374           2</span></span>
<span><span class="co">## 90%       0.90       20.398697           4</span></span>
<span><span class="co">## 85%       0.85       14.158347           5</span></span>
<span><span class="co">## 80%       0.80        8.926723           7</span></span>
<span><span class="co">## 75%       0.75        5.267123           8</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">threshold_comparison</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">percentile</span> <span class="op">*</span> <span class="fl">100</span>, y <span class="op">=</span> <span class="va">n_anomalies</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"steelblue"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"darkred"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Number of Anomalies by Threshold Percentile"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Percentile Threshold (%)"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Number of Anomalies"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">thresholds</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/threshold-selection-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level3">
<h3 id="anomaly-classification-with-threshold">Anomaly Classification with Threshold<a class="anchor" aria-label="anchor" href="#anomaly-classification-with-threshold"></a>
</h3>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Classify as anomaly if score below 10th percentile</span></span>
<span><span class="va">threshold_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mtcars_with_scores</span><span class="op">$</span><span class="va">anomaly_score</span>, <span class="fl">0.90</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mtcars_classified</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    is_anomaly_10pct <span class="op">=</span> <span class="va">anomaly_score</span> <span class="op">&gt;=</span> <span class="va">threshold_10</span>,</span>
<span>    classification <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_anomaly_10pct</span>, <span class="st">"Anomaly"</span>, <span class="st">"Normal"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary</span></span>
<span><span class="va">summary_table</span> <span class="op">&lt;-</span> <span class="va">mtcars_classified</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">classification</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>,</span>
<span>    mean_hp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">hp</span><span class="op">)</span>,</span>
<span>    mean_wt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">wt</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summary_table</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">##   classification     n mean_mpg mean_hp mean_wt</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> Anomaly            4     22.0    180.    2.75</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> Normal            28     19.8    142     3.28</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_classified</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">classification</span>, y <span class="op">=</span> <span class="va">mpg</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">classification</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Normal"</span> <span class="op">=</span> <span class="st">"steelblue"</span>, <span class="st">"Anomaly"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"MPG Distribution: Normal vs Anomalous"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Classification"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Miles Per Gallon"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/anomaly-classification-1.png" class="r-plt" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="analyzing-specific-anomalies">Analyzing Specific Anomalies<a class="anchor" aria-label="anchor" href="#analyzing-specific-anomalies"></a>
</h2>
<div class="section level3">
<h3 id="detailed-inspection">Detailed Inspection<a class="anchor" aria-label="anchor" href="#detailed-inspection"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get top 5 most anomalous cars</span></span>
<span><span class="va">top_anomalies</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">anomaly_score</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">top_anomalies</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"car_name"</span>, <span class="st">"anomaly_score"</span>, <span class="st">"mpg"</span>, <span class="st">"cyl"</span>, <span class="st">"disp"</span>, <span class="st">"hp"</span>, <span class="st">"wt"</span>, <span class="st">"qsec"</span>, <span class="st">"am"</span>, <span class="st">"gear"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                            car_name anomaly_score  mpg cyl  disp  hp    wt</span></span>
<span><span class="co">## AMC Javelin             AMC Javelin     0.2061268 15.2   8 304.0 150 3.435</span></span>
<span><span class="co">## Dodge Challenger   Dodge Challenger     0.2446634 15.5   8 318.0 150 3.520</span></span>
<span><span class="co">## Merc 450SL               Merc 450SL     0.2488258 17.3   8 275.8 180 3.730</span></span>
<span><span class="co">## Hornet Sportabout Hornet Sportabout     0.3119090 18.7   8 360.0 175 3.440</span></span>
<span><span class="co">## Merc 450SLC             Merc 450SLC     0.3575786 15.2   8 275.8 180 3.780</span></span>
<span><span class="co">##                    qsec am gear</span></span>
<span><span class="co">## AMC Javelin       17.30  0    3</span></span>
<span><span class="co">## Dodge Challenger  16.87  0    3</span></span>
<span><span class="co">## Merc 450SL        17.60  0    3</span></span>
<span><span class="co">## Hornet Sportabout 17.02  0    3</span></span>
<span><span class="co">## Merc 450SLC       18.00  0    3</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare each anomaly to median values</span></span>
<span><span class="va">median_values</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    median_mpg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span>,</span>
<span>    median_hp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">hp</span><span class="op">)</span>,</span>
<span>    median_wt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">wt</span><span class="op">)</span>,</span>
<span>    median_qsec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">qsec</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Median Values (Normal) ===\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === Median Values (Normal) ===</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">median_values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   median_mpg median_hp median_wt median_qsec</span></span>
<span><span class="co">## 1       19.2       123     3.325       17.71</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Anomaly Deviation from Median ===\n"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## === Anomaly Deviation from Median ===</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">anomaly_deviation</span> <span class="op">&lt;-</span> <span class="va">top_anomalies</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">car_name</span>, <span class="va">mpg</span>, <span class="va">hp</span>, <span class="va">wt</span>, <span class="va">qsec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    mpg_diff <span class="op">=</span> <span class="va">mpg</span> <span class="op">-</span> <span class="va">median_values</span><span class="op">$</span><span class="va">median_mpg</span>,</span>
<span>    hp_diff <span class="op">=</span> <span class="va">hp</span> <span class="op">-</span> <span class="va">median_values</span><span class="op">$</span><span class="va">median_hp</span>,</span>
<span>    wt_diff <span class="op">=</span> <span class="va">wt</span> <span class="op">-</span> <span class="va">median_values</span><span class="op">$</span><span class="va">median_wt</span>,</span>
<span>    qsec_diff <span class="op">=</span> <span class="va">qsec</span> <span class="op">-</span> <span class="va">median_values</span><span class="op">$</span><span class="va">median_qsec</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">anomaly_deviation</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"car_name"</span>, <span class="st">"mpg_diff"</span>, <span class="st">"hp_diff"</span>, <span class="st">"wt_diff"</span>, <span class="st">"qsec_diff"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                            car_name mpg_diff hp_diff wt_diff qsec_diff</span></span>
<span><span class="co">## AMC Javelin             AMC Javelin     -4.0      27   0.110     -0.41</span></span>
<span><span class="co">## Dodge Challenger   Dodge Challenger     -3.7      27   0.195     -0.84</span></span>
<span><span class="co">## Merc 450SL               Merc 450SL     -1.9      57   0.405     -0.11</span></span>
<span><span class="co">## Hornet Sportabout Hornet Sportabout     -0.5      52   0.115     -0.69</span></span>
<span><span class="co">## Merc 450SLC             Merc 450SLC     -4.0      57   0.455      0.29</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="parallel-coordinates-plot">Parallel Coordinates Plot<a class="anchor" aria-label="anchor" href="#parallel-coordinates-plot"></a>
</h3>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prepare data for parallel coordinates</span></span>
<span><span class="va">parallel_df</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">observation</span>,<span class="va">is_anomaly_10pct</span>, <span class="va">mpg</span>, <span class="va">hp</span>, <span class="va">wt</span>, <span class="va">qsec</span>, <span class="va">gear</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_anomaly_10pct <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">is_anomaly_10pct</span>, <span class="st">"Anomaly"</span>, <span class="st">"Normal"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">hp</span>, <span class="va">wt</span>, <span class="va">qsec</span>, <span class="va">gear</span><span class="op">)</span>,</span>
<span>               names_to <span class="op">=</span> <span class="st">"feature"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    feature_label <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"mpg"</span> <span class="op">~</span> <span class="st">"MPG"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"hp"</span> <span class="op">~</span> <span class="st">"Horsepower"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"wt"</span> <span class="op">~</span> <span class="st">"Weight"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"qsec"</span> <span class="op">~</span> <span class="st">"1/4 mile time"</span>,</span>
<span>      <span class="va">feature</span> <span class="op">==</span> <span class="st">"gear"</span> <span class="op">~</span> <span class="st">"Gears"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Normalize within features</span></span>
<span>    value_norm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">parallel_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">feature_label</span>, y <span class="op">=</span> <span class="va">value_norm</span>, color <span class="op">=</span> <span class="va">is_anomaly_10pct</span>, group <span class="op">=</span> <span class="va">observation</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_summary.html" class="external-link">stat_summary</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">mean</span>, geom <span class="op">=</span> <span class="st">"line"</span>, linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Normal"</span> <span class="op">=</span> <span class="st">"steelblue"</span>, <span class="st">"Anomaly"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Parallel Coordinates: Normal vs Anomalous"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Thick lines show mean profiles"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Feature"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Normalized Value"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/parallel-coordinates-1.png" class="r-plt" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="time-series-style-anomaly-detection">Time-Series Style Anomaly Detection<a class="anchor" aria-label="anchor" href="#time-series-style-anomaly-detection"></a>
</h2>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Order by one feature (e.g., weight) to simulate time-series</span></span>
<span><span class="va">mtcars_ordered</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">wt</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>order_idx <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mtcars_ordered</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">order_idx</span>, y <span class="op">=</span> <span class="va">anomaly_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gray70"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">is_anomaly</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">threshold_10</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"steelblue"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Anomaly Scores by Vehicle Weight Order"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Dashed line = 10th percentile threshold"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Order by Weight"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Anomaly Score"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Anomaly"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/timeseries-style-1.png" class="r-plt" width="700"></p>
</div>
<div class="section level2">
<h2 id="using-with-prediction">Using with Prediction<a class="anchor" aria-label="anchor" href="#using-with-prediction"></a>
</h2>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine with regression predictions</span></span>
<span><span class="va">X_reg</span> <span class="op">&lt;-</span> <span class="va">mtcars</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"disp"</span>, <span class="st">"hp"</span>, <span class="st">"wt"</span>, <span class="st">"qsec"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">y_reg</span> <span class="op">&lt;-</span> <span class="va">mtcars</span><span class="op">$</span><span class="va">mpg</span></span>
<span></span>
<span><span class="co"># Train regression model</span></span>
<span><span class="va">reg_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tab_pfn_regression.html">tab_pfn_regression</a></span><span class="op">(</span><span class="va">X_reg</span>, <span class="va">y_reg</span>, device <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get predictions</span></span>
<span><span class="va">reg_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">reg_model</span>, <span class="va">X_reg</span>, type <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine with anomaly scores</span></span>
<span><span class="va">combined_df</span> <span class="op">&lt;-</span> <span class="va">mtcars_with_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">car_name</span>, <span class="va">anomaly_score</span>, <span class="va">mpg</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    predicted_mpg <span class="op">=</span> <span class="va">reg_preds</span><span class="op">$</span><span class="va">.pred</span>,</span>
<span>    prediction_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">-</span> <span class="va">predicted_mpg</span><span class="op">)</span>,</span>
<span>    is_anomaly_10pct <span class="op">=</span> <span class="va">anomaly_score</span> <span class="op">&lt;=</span> <span class="va">threshold_10</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare prediction error for normal vs anomalous</span></span>
<span><span class="va">error_comparison</span> <span class="op">&lt;-</span> <span class="va">combined_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">is_anomaly_10pct</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    mean_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">prediction_error</span><span class="op">)</span>,</span>
<span>    median_error <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">prediction_error</span><span class="op">)</span>,</span>
<span>    .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">error_comparison</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">##   is_anomaly_10pct     n mean_error median_error</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> FALSE                4      0.751        0.489</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> TRUE                28      1.55         1.41</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">is_anomaly_10pct</span>, y <span class="op">=</span> <span class="va">prediction_error</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">is_anomaly_10pct</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"steelblue"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"darkred"</span><span class="op">)</span>,</span>
<span>                     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"Normal"</span>, <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"Anomalous"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Prediction Error: Normal vs Anomalous"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Classification"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Absolute Prediction Error (MPG)"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Classification"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="anomaly-detection_files/figure-html/with-prediction-1.png" class="r-plt" width="576"></p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>Unsupervised anomaly detection with TabPFN provides:</p>
<ul>
<li>
<strong>No labeled data needed</strong>: Detects anomalies based on
data distribution</li>
<li>
<strong>Probability-based scoring</strong>: Lower scores indicate
more anomalous observations</li>
<li>
<strong>Flexible threshold selection</strong>: Choose appropriate
threshold based on domain needs</li>
<li>
<strong>Multi-dimensional detection</strong>: Considers all features
simultaneously</li>
<li>
<strong>Interpretable results</strong>: Can analyze which features
drive anomalous behavior</li>
</ul>
<p>Key applications: - Data quality monitoring - Fraud detection -
System health monitoring - Novelty detection - Outlier analysis for
model improvement</p>
<p>The method is particularly useful when: - You have unlabeled data -
You need to identify rare or unusual patterns - You want to understand
data distribution anomalies - You’re preparing data for supervised
learning</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Cedric Bouffard.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
